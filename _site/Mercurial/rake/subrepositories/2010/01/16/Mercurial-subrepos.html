<!DOCTYPE html>
<html>
  <head>
    <title>Rakefile for dealing with mercurial subrepos</title>
  </head>

  <body>
    <div id="content">
      <h1>Rakefile for dealing with mercurial subrepos</h1>
      <p>Since versioin 1.3 Mercurial has support for sub repositories.</p>
<div>
  <pre>
    <code class='ruby'>begin
  require 'term/ansicolor'
  class String
    include Term::ANSIColor
  end
rescue LoadError =&gt; e
  STDERR.puts &quot;Please install gem term-ansicolor to use this rakefile.&quot;
  exit(1)
end

@repos = Dir[&quot;*/.hg&quot;].map { |f| File.split(f).first } + [Dir.pwd]
def on_repos(cmd)
  @repos.each do |project|
    begin
      puts &quot;= #{project.red} (#{cmd.yellow})&quot;
      system &quot;cd #{project}; #{cmd}&quot;
    rescue =&gt; e
      puts &quot;Failed because: #{e}&quot;.red
    end
  end
end

desc &quot;Invokes any hg command on every repo. Provide CMD=command env variable.&quot;
task :hg do
  if ENV['CMD'].nil?
    puts &quot;Missing rev parameter&quot;
  else
    on_repos(&quot;hg #{ENV['CMD']}&quot;)
  end
end

desc &quot;Rebase wszystkich projekt√≥w&quot;
task :rebase do
  on_repos(&quot;hg pull --rebase&quot;)
end

desc &quot;Pull&quot;
task :pull do
  on_repos(&quot;hg pull&quot;)
end

desc &quot;Pull -u&quot;
task :update do
  on_repos(&quot;hg pull -u&quot;)
end

desc &quot;Status&quot;
task :status do
  on_repos(&quot;hg status&quot;)
end

desc &quot;Push&quot;
task :push do
  on_repos(&quot;hg push&quot;)
end

desc &quot;Tag repos. Provide name=tag_name param&quot;
task :tag do |t, args|
  if args.name.nil?
    puts &quot;Missing name parameter&quot;
  else 
    on_repos(&quot;hg tag #{args.name}&quot;)
  end
end

desc &quot;Update all repos to some revision. Provide rev=revision parameter.&quot;
task :upto do |t, args|
  if args.rev.nil?
    puts &quot;Missing rev parameter&quot;
  else
    on_repos(&quot;hg update -C #{args.name}&quot;)
  end
end

desc &quot;Commits main repository and adds commits messages from every subrepo.&quot;
task :commit do
  require 'time'
  last_date = Time.parse(%x{hg tip --template '{date|isodate}'}) + 60
  date = last_date.strftime(&quot;%Y-%m-%d %H:%M&quot;)
  out = @repos.reject { |r| File.basename(r) == &quot;itiner&quot; }.map do |r| 
    log = %x{cd #{r} &amp;&amp; hg log -d '&gt;#{date}' --template=&quot;== {desc}\n&quot;}.strip
    log.empty? ? nil : &quot;= #{File.basename r}\n#{log}&quot;
  end
  msg = out.compact.join(&quot;\n\n&quot;).strip
  # mac only?
  IO.popen('pbcopy', 'w') do |pipe|
    pipe.print(msg)
  end
  system &quot;hg commit &amp;&amp; hg push&quot;
end</code>
  </pre>
</div>
    </div>
    <div id="related">
      Related posts:
      
      <a href="/2010/01/15/LaTeX-with-Rakefile.html">2010-01-15 WYSIWYG in LaTeX with Rakefile</a><br />
      
    </div>
  </body>
</html>